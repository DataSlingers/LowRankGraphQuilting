
addpath(genpath('./'))

%% Simulate graph structure

% Simulation parameters: 
%%% Number of data points for empirical covariance matrix.
n = 2000;
%%% Number of features.
p = 100;
%%% Number of blocks.
K = 2;
%%% Number of features per block; K * o must be greater than p.
o = 60;
%%% Low-rankness of simulated graph.
eigv = 0.01;
%%% Graph type.
graph_type = 'block';
%%% Seed
seed = 1000;
%%% Output folder for results
output_folder = './ExampleOutput/';
% Maximum rank to estimate for in LRF and BSVD methods.
max_rank = 30;

% Create cov mat and inverse cov mat with desired graph structure.
[Theta,Sigma]=graph_generator(p,seed,eigv,output_folder,graph_type);

%% Generate partially observed empirical covariance matrix

[Sigma_obs, Sigma_n, S_obs, Omega, X] = patch_simulator(Sigma, n, K, o, seed, output_folder);

%% Run covariance imputation.
% Sigma_obs: matrix, observed parts of covariance matrix; 0 for
% non-observed entries.
% S_obs: cell, list of features in each block.
% max_rank: integer, maximum rank to estimate for in LRF and BSVD methods.
% output_folder: string, desired location to save imputed covariance matrices.
[output] = LRGQ_imp(Sigma_obs, S_obs, max_rank, output_folder);


%% Run graph estimation.
% Saves estimated graphs from imputed covariance matrices in
% /GraphEstimation subfolder in output_folder.
% Uses saved imputed covariance matrices in /Imputed subfolder in
% output_folder as produced by LRGQ_imp.m.

R_call = ['R CMD BATCH ', '"--args ', output_folder ,'" ' ,'./GraphEstimation/GraphEstimationR.R ', ...
    output_folder, 'ROutput.Rout '];
system(R_call);

%% Evaluate imputation performance
% Saves best Frobenius norm in output folder as ImputationError.csv.
% Uses outputs from patch_simulator.m, LRGQ_imp.m.
[imp_err] = ImpAnalysis(output, Sigma_obs, Sigma, Sigma_n, S_obs, output_folder);

%% Evaluate graph performance
% Saves best F-1 score in output folder as F1Results.csv.

R_call = ['R CMD BATCH ', '"--args ', output_folder ,'" ' ,'./SimAnalysis/GraphAnalysis.R ', ...
    output_folder, 'RAnalysis.Rout '];
system(R_call);